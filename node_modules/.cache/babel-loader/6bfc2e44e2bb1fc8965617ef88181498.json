{"ast":null,"code":"'use strict';\n\nvar _classCallCheck = require(\"/Users/michaelkim/Documents/battery-project/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"/Users/michaelkim/Documents/battery-project/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createClass\");\n\nvar packageData = require('../../package.json');\n\nvar shared = require('../shared');\n/**\n * Generates a Transport object for streaming\n *\n * Possible options can be the following:\n *\n *  * **buffer** if true, then returns the message as a Buffer object instead of a stream\n *  * **newline** either 'windows' or 'unix'\n *\n * @constructor\n * @param {Object} optional config parameter\n */\n\n\nvar StreamTransport = /*#__PURE__*/function () {\n  function StreamTransport(options) {\n    _classCallCheck(this, StreamTransport);\n\n    options = options || {};\n    this.options = options || {};\n    this.name = 'StreamTransport';\n    this.version = packageData.version;\n    this.logger = shared.getLogger(this.options, {\n      component: this.options.component || 'stream-transport'\n    });\n    this.winbreak = ['win', 'windows', 'dos', '\\r\\n'].includes((options.newline || '').toString().toLowerCase());\n  }\n  /**\n   * Compiles a mailcomposer message and forwards it to handler that sends it\n   *\n   * @param {Object} emailMessage MailComposer object\n   * @param {Function} callback Callback function to run when the sending is completed\n   */\n\n\n  _createClass(StreamTransport, [{\n    key: \"send\",\n    value: function send(mail, done) {\n      var _this = this;\n\n      // We probably need this in the output\n      mail.message.keepBcc = true;\n      var envelope = mail.data.envelope || mail.message.getEnvelope();\n      var messageId = mail.message.messageId();\n      var recipients = [].concat(envelope.to || []);\n\n      if (recipients.length > 3) {\n        recipients.push('...and ' + recipients.splice(2).length + ' more');\n      }\n\n      this.logger.info({\n        tnx: 'send',\n        messageId: messageId\n      }, 'Sending message %s to <%s> using %s line breaks', messageId, recipients.join(', '), this.winbreak ? '<CR><LF>' : '<LF>');\n      setImmediate(function () {\n        var stream;\n\n        try {\n          stream = mail.message.createReadStream();\n        } catch (E) {\n          _this.logger.error({\n            err: E,\n            tnx: 'send',\n            messageId: messageId\n          }, 'Creating send stream failed for %s. %s', messageId, E.message);\n\n          return done(E);\n        }\n\n        if (!_this.options.buffer) {\n          stream.once('error', function (err) {\n            _this.logger.error({\n              err: err,\n              tnx: 'send',\n              messageId: messageId\n            }, 'Failed creating message for %s. %s', messageId, err.message);\n          });\n          return done(null, {\n            envelope: mail.data.envelope || mail.message.getEnvelope(),\n            messageId: messageId,\n            message: stream\n          });\n        }\n\n        var chunks = [];\n        var chunklen = 0;\n        stream.on('readable', function () {\n          var chunk;\n\n          while ((chunk = stream.read()) !== null) {\n            chunks.push(chunk);\n            chunklen += chunk.length;\n          }\n        });\n        stream.once('error', function (err) {\n          _this.logger.error({\n            err: err,\n            tnx: 'send',\n            messageId: messageId\n          }, 'Failed creating message for %s. %s', messageId, err.message);\n\n          return done(err);\n        });\n        stream.on('end', function () {\n          return done(null, {\n            envelope: mail.data.envelope || mail.message.getEnvelope(),\n            messageId: messageId,\n            message: Buffer.concat(chunks, chunklen)\n          });\n        });\n      });\n    }\n  }]);\n\n  return StreamTransport;\n}();\n\nmodule.exports = StreamTransport;","map":null,"metadata":{},"sourceType":"script"}